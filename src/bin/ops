#!bash

set -e # Exit on first failure

main() {
  local cmd="$1"
  local arg1="$2"
  local arg2="$3"

  case "$cmd" in
    instances) list_instances $arg1;;
    layers) list_layers $arg1;;
    ssh) connect_with_ssh $arg1 $arg2;;
    ssh-tunnel) establish_ssh_tunnel $arg1 $arg2;;
    stacks) list_stacks;;
    *) usage;;
  esac
}

function _echoerr() {
  echo "$*" >&2
}

function _choose_instance() {
  local stackId=$1
  local query=$2

  aws --region us-east-1 opsworks describe-instances --stack-id=$stackId |
    jq --raw-output '.Instances | .[] | "\(.Hostname)|\(.PublicIp)|\(.InstanceId)"' |
    sort -r |
    column -t -s'|' |
    fzf --select-1 --exit-0 --query=$query |
    awk -F' ' '{print $NF}'
}

function _choose_stack() {
  local query=$1 # optional

  aws --region us-east-1 opsworks describe-stacks |
    jq --raw-output '.Stacks | .[] | .Name + "|" + .StackId' |
    sort -r |
    column -t -s'|' |
    fzf --select-1 --exit-0 --query=$query |
    awk -F' ' '{print $NF}'
}

function _choose_layer() {
  local stackId=$1
  local query=$2 # optional

  if [ -z $stackId ]; then
    _echoerr "Must select a stack to choose a layer"
    exit 1
  fi

  aws --region us-east-1 opsworks describe-layers --stack-id=$stackId |
    jq --raw-output '.Layers | .[] | .Name + "|" + .LayerId' |
    sort -r |
    column -t -s'|' |
    fzf --select-1 --exit-0 --query=$query |
    awk -F' ' '{print $NF}'
}

function _fetch_username() {
  aws --region us-east-1 opsworks describe-my-user-profile |
    jq --raw-output .UserProfile.SshUsername
}

function _fetch_instance_details() {
  instanceId=$1
  field=$2

  aws --region us-east-1 opsworks describe-instances --instance-id=$instanceId |
    jq --raw-output ".Instances[0].$field"
}

function usage() {
  echo "$(basename $0) (instances layers stacks)"
  echo
  column -s'|' -t <<-EOH
  instances [STACK]|list instances in a given Opsworks stack
  layers [STACK]|list layers in a given Opsworks stack
  stacks|list Opsworks stacks
EOH
}

function establish_ssh_tunnel() {
  # TODO need to get OpsWorks username to connect with; then `exec ssh username@ip`
  _echoerr "TK; SSH tunnel not yet implemented"
}

function list_instances() {
  local stackQuery=$1
  local stackId=$(_choose_stack $stackQuery)
  # TODO map layer IDs to human-readable names
  # for reference, hash with ID as the key: jq '.Layers | map({(.LayerId): {name: .Name, shortname: .Shortname}}) | add'
  aws --region us-east-1 opsworks describe-instances --stack-id=$stackId |
    jq '[.Instances | .[] | {name: .Hostname, id: .InstanceId, ip: .PublicIp, layers: .LayerIds, status: .Status, type: .InstanceType}]'
}

function list_layers() {
  local stackQuery=$1
  local stackId=$(_choose_stack $stackQuery)
  aws --region us-east-1 opsworks describe-layers --stack-id=$stackId |
    jq '[.Layers | .[] | {id: .LayerId, name: .Name, shortname: .Shortname}]'
}

function list_stacks() {
  aws --region us-east-1 opsworks describe-stacks |
    jq '[.Stacks | .[] | {id: .StackId, name: .Name}]'
}

function connect_with_ssh() {
  local stackQuery=$1
  local instanceQuery=$2
  local stackId=$(_choose_stack $stackQuery)
  local instanceId=$(_choose_instance $stackId $instanceQuery)

  local username=$(_fetch_username)
  local instanceIp=$(_fetch_instance_details $instanceId PublicIp)

  # echo command when executing
  (set -x; ssh $username@$instanceIp)
}

main $*
